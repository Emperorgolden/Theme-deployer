#!/bin/bash

# Golden Hosting Enterprise - Custom Theme Toolkit (Safe Mode)
# Fully featured: install/uninstall theme, colorful output, safe Laravel-compliant layout

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

clear
echo -e "${CYAN}=================================================="
echo -e " Golden Hosting Enterprise - Theme Deployer"
echo -e "==================================================${NC}"
echo

# Prompt install or uninstall
echo -e "${YELLOW}[1]${NC} Install Theme"
echo -e "${YELLOW}[2]${NC} Uninstall (Restore Backup)"
read -p "Select an option [1-2]: " option

if [[ "$option" == "2" ]]; then
    if [[ -f /var/www/pterodactyl/resources/views/templates/wrapper.backup.blade.php ]]; then
        cp /var/www/pterodactyl/resources/views/templates/wrapper.backup.blade.php \
           /var/www/pterodactyl/resources/views/templates/wrapper.blade.php
        echo -e "${GREEN}[RESTORED]${NC} wrapper.blade.php has been restored from backup."
    else
        echo -e "${RED}[ERROR]${NC} No backup found. Cannot restore."
        exit 1
    fi

    cd /var/www/pterodactyl || exit
    php artisan view:clear
    php artisan config:clear
    php artisan up
    systemctl restart php8.3-fpm 2>/dev/null || systemctl restart php8.2-fpm 2>/dev/null
    systemctl restart nginx
    echo -e "${GREEN}[DONE]${NC} Theme uninstalled."
    exit 0
fi

# Install Theme
read -p "Enter direct image URL for background: " bg_url
if [[ -z "$bg_url" ]]; then
    echo -e "${RED}[ERROR]${NC} No image URL provided. Exiting."
    exit 1
fi

echo -e "${CYAN}[INFO]${NC} Downloading background image..."
mkdir -p /var/www/pterodactyl/public/assets/img
wget -q "$bg_url" -O /var/www/pterodactyl/public/assets/img/custom_bg.jpg

if [[ $? -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Failed to download image."
    exit 1
fi
chmod 644 /var/www/pterodactyl/public/assets/img/custom_bg.jpg

# Write CSS file
cat <<EOF > /var/www/pterodactyl/public/assets/custom-background.css
body {
    background-image: url('/assets/img/custom_bg.jpg');
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center;
}
EOF

echo -e "${CYAN}[INFO]${NC} Backing up original Blade wrapper..."
cp /var/www/pterodactyl/resources/views/templates/wrapper.blade.php \
   /var/www/pterodactyl/resources/views/templates/wrapper.backup.blade.php

# Write safe wrapper
cat <<'EOW' > /var/www/pterodactyl/resources/views/templates/wrapper.blade.php
<!DOCTYPE html>
<html>
    <head>
        <title>{{ config('app.name', 'Pterodactyl') }}</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="csrf-token" content="{{ csrf_token() }}">
        <meta name="robots" content="noindex">

        <link rel="stylesheet" href="/assets/custom-background.css">
        <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png">
        <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png">
        <link rel="manifest" href="/favicons/manifest.json">
        <link rel="shortcut icon" href="/favicons/favicon.ico">

        <style>
            @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap');
            body {
                font-family: 'Rubik', sans-serif;
            }
        </style>

        @yield('assets')
    </head>
    <body class="{{ $css['body'] ?? 'bg-neutral-50' }}">
        @yield('content')
        @yield('scripts')

        <footer style="text-align:center; padding:1em; font-size: 0.9em; color:#ccc;">
            All rights reserved by Golden Hosting Enterprise Â© 2025
        </footer>
    </body>
</html>
EOW

cd /var/www/pterodactyl || exit
php artisan view:clear
php artisan config:clear
php artisan up

systemctl restart php8.3-fpm 2>/dev/null || systemctl restart php8.2-fpm 2>/dev/null
systemctl restart nginx

echo -e "\n${GREEN}[DONE]${NC} Theme installed successfully."
