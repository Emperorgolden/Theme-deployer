#!/bin/bash

# Golden Hosting Enterprise - Stable Theme Deployer

clear
echo "----------------------------------------------------"
echo " Golden Hosting Enterprise - Pterodactyl Themer"
echo "----------------------------------------------------"

read -p "Enter direct image URL for background: " bg_url

if [[ -z "$bg_url" ]]; then
    echo "[ERROR] No image URL provided. Exiting."
    exit 1
fi

echo "[INFO] Downloading background image..."
mkdir -p /var/www/pterodactyl/public/assets/img
wget -q "$bg_url" -O /var/www/pterodactyl/public/assets/img/custom_bg.jpg

if [[ $? -ne 0 ]]; then
    echo "[ERROR] Failed to download image."
    exit 1
fi

chmod 644 /var/www/pterodactyl/public/assets/img/custom_bg.jpg

echo "[INFO] Writing custom CSS..."
cat <<EOF > /var/www/pterodactyl/public/assets/custom-background.css
body {
    background-image: url('/assets/img/custom_bg.jpg');
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center;
}
EOF

echo "[INFO] Backing up original Blade wrapper..."
cp /var/www/pterodactyl/resources/views/templates/wrapper.blade.php \
   /var/www/pterodactyl/resources/views/templates/wrapper.backup.blade.php

echo "[INFO] Deploying new wrapper..."
cat <<'EOW' > /var/www/pterodactyl/resources/views/templates/wrapper.blade.php
@extends('templates.base.core')

@section('content')
    @section('meta')
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="csrf-token" content="{{ csrf_token() }}">
        <meta name="robots" content="noindex">
        <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="/favicons/manifest.json">
        <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#bc6e3c">
        <link rel="shortcut icon" href="/favicons/favicon.ico">
        <meta name="msapplication-config" content="/favicons/browserconfig.xml">
        <meta name="theme-color" content="#0e4688">
    @show

    @section('user-data')
        @if (!is_null(Auth::user()))
            <script>
                window.PterodactylUser = {!! json_encode(Auth::user()->toVueObject()) !!};
            </script>
        @endif
        @if (!empty($siteConfiguration))
            <script>
                window.SiteConfiguration = {!! json_encode($siteConfiguration) !!};
            </script>
        @endif
    @show

    <link rel="stylesheet" href="/assets/custom-background.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@500&display=swap');
    </style>

    @yield('assets')
    @include('layouts.scripts')

    <div id="app">
        @yield('above-container')
        @yield('container')
        @yield('below-container')
    </div>

    @yield('scripts')

    <footer style="text-align:center; padding:1em; font-size: 0.9em; color:#ccc;">
        All rights reserved by Golden Hosting Enterprise Â© 2025
    </footer>
@endsection
EOW

echo "[INFO] Clearing cache..."
cd /var/www/pterodactyl || exit
php artisan view:clear
php artisan config:clear
php artisan cache:clear
php artisan up

echo "[INFO] Restarting services..."
systemctl restart php8.3-fpm 2>/dev/null || systemctl restart php8.2-fpm 2>/dev/null
systemctl restart nginx

echo
echo "[DONE] Theme applied successfully. Backup saved."
echo "----------------------------------------------------"
