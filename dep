#!/bin/bash

# Golden Hosting Enterprise - NookTheme Installer + Safe Custom Theme
# Includes full install, backup, and uninstall options

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

clear
echo -e "${CYAN}=================================================="
echo -e " Golden Hosting Enterprise - Full Panel Themer"
echo -e " NookTheme • Background • Footer • Uninstall Option"
echo -e "==================================================${NC}"
echo

# Main Menu
echo -e "${YELLOW}[1]${NC} Install NookTheme + Custom Theme"
echo -e "${YELLOW}[2]${NC} Uninstall Theme (Restore Backup)"
read -p "Choose an option [1-2]: " option

if [[ "$option" == "2" ]]; then
    echo -e "${CYAN}[INFO]${NC} Restoring backup..."
    WRAPPER="/var/www/pterodactyl/resources/views/templates/wrapper.blade.php"
    BACKUP="$WRAPPER.bak"

    if [[ -f "$BACKUP" ]]; then
        cp "$BACKUP" "$WRAPPER"
        rm -f /var/www/pterodactyl/public/assets/custom-background.css
        rm -f /var/www/pterodactyl/public/assets/img/custom_bg.jpg
        echo -e "${GREEN}[RESTORED]${NC} Theme removed and panel restored."

        cd /var/www/pterodactyl || exit
        php artisan view:clear
        php artisan config:clear
        php artisan up
        systemctl restart php8.3-fpm 2>/dev/null || systemctl restart php8.2-fpm 2>/dev/null
        systemctl restart nginx
        exit 0
    else
        echo -e "${RED}[ERROR]${NC} No backup found. Cannot uninstall."
        exit 1
    fi
fi

# Install starts here
cd /var/www/pterodactyl || exit
php artisan down

echo -e "${CYAN}[INFO]${NC} Installing NookTheme..."
curl -L https://github.com/Nookure/NookTheme/releases/latest/download/panel.tar.gz | tar -xzv

chmod -R 755 storage/* bootstrap/cache
composer install --no-dev --optimize-autoloader

php artisan view:clear
php artisan config:clear
php artisan migrate --seed --force
chown -R www-data:www-data /var/www/pterodactyl/*
php artisan queue:restart
php artisan up

read -p "Enter direct image URL for background: " bg_url
if [[ -z "$bg_url" ]]; then
    echo -e "${RED}[ERROR]${NC} No image URL provided. Exiting."
    exit 1
fi

mkdir -p /var/www/pterodactyl/public/assets/img
wget -q "$bg_url" -O /var/www/pterodactyl/public/assets/img/custom_bg.jpg
chmod 644 /var/www/pterodactyl/public/assets/img/custom_bg.jpg

cat <<EOF > /var/www/pterodactyl/public/assets/custom-background.css
body {
    background-image: url('/assets/img/custom_bg.jpg');
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center;
}
EOF

WRAPPER="/var/www/pterodactyl/resources/views/templates/wrapper.blade.php"
BACKUP="$WRAPPER.bak"
[ ! -f "$BACKUP" ] && cp "$WRAPPER" "$BACKUP"

cat <<'EOW' > "$WRAPPER"
@extends('templates.base.core')

@section('content')
    <link rel="stylesheet" href="/assets/custom-background.css">

    @yield('above-container')
    @yield('container')
    @yield('below-container')

    <footer style="text-align:center; padding:1em; font-size:0.9em; color:#ccc;">
        All rights reserved by Golden Hosting Enterprise © 2025
    </footer>
@endsection
EOW

php artisan view:clear
php artisan config:clear
php artisan up
systemctl restart php8.3-fpm 2>/dev/null || systemctl restart php8.2-fpm 2>/dev/null
systemctl restart nginx

echo -e "${GREEN}[DONE]${NC} NookTheme + custom background installed successfully."
