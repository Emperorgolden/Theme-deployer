#!/bin/bash

# ╔══════════════════════════════════════════════╗
# ║  Golden Hosting Enterprise™ Theme Deployer  ║
# ╚══════════════════════════════════════════════╝

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}"
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║ Welcome to Golden Hosting Enterprise Theme Manager 🎨    ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo -e "${NC}"

echo -e "${BLUE}[?] Do you want to install or uninstall the theme?${NC}"
echo "1) Install"
echo "2) Uninstall"
read -p "👉 Enter choice (1 or 2): " CHOICE

if [ "$CHOICE" == "2" ]; then
    echo -e "${YELLOW}[•] Reverting theme...${NC}"
    cd /var/www/pterodactyl || exit 1
    php artisan down

    echo -e "${BLUE}[~] Restoring original panel files from GitHub..."
    curl -L https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz | tar -xzv

    php artisan view:clear
    php artisan config:clear
    php artisan migrate --seed --force
    php artisan up

    echo -e "${GREEN}✅ Theme uninstalled. Panel restored to default.${NC}"
    exit 0
fi

read -p "🌄 Enter your background image URL: " IMAGE_URL
IMAGE_NAME="custom_bg.jpg"
DEST_PATH="/var/www/pterodactyl/public/assets/img/$IMAGE_NAME"

echo -e "${BLUE}[~] Downloading background image from:${NC} $IMAGE_URL"
mkdir -p /var/www/pterodactyl/public/assets/img/
curl -L "$IMAGE_URL" -o "$DEST_PATH"

if [ ! -f "$DEST_PATH" ]; then
    echo -e "${RED}[✘] Failed to download image. Exiting.${NC}"
    exit 1
fi

echo -e "${YELLOW}[•] Installing NookTheme...${NC}"
cd /var/www/pterodactyl || exit 1
php artisan down

curl -L https://github.com/Nookure/NookTheme/releases/latest/download/panel.tar.gz | tar -xzv
chmod -R 755 storage/* bootstrap/cache
composer install --no-dev --optimize-autoloader
php artisan view:clear
php artisan config:clear
php artisan migrate --seed --force
php artisan queue:restart

echo -e "${BLUE}[✓] Injecting background CSS...${NC}"
mkdir -p public/assets/
cat <<EOF > public/assets/custom-background.css
body {
  background: url('/assets/img/$IMAGE_NAME') no-repeat center center fixed;
  background-size: cover;
  background-color: #000;
}
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: -1;
}
EOF

LAYOUT="resources/views/templates/wrapper.blade.php"

if ! grep -q "custom-background.css" "$LAYOUT"; then
    sed -i "/@include('layouts.scripts')/a <link rel=\"stylesheet\" href=\"/assets/custom-background.css\">" "$LAYOUT"
fi

if ! grep -q "Golden Hosting Enterprise" "$LAYOUT"; then
    sed -i '/<\/body>/i \
<footer style="text-align:center; padding:1em; font-size: 0.9em; color:#ccc;">\
All rights reserved by Golden Hosting Enterprise © 2025\
</footer>' "$LAYOUT"
fi

php artisan up

echo -e "${GREEN}🎉 Theme Installed Successfully!${NC}"
echo -e "${BLUE}✔️ Background: $IMAGE_URL"
echo -e "✔️ Footer: Golden Hosting Enterprise"
echo -e "✔️ NookTheme applied"
