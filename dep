#!/bin/bash

# Golden Hosting Enterprise - Theme Toolkit (Final Mega Edition)
# Fully automated, interactive, handles Nightcore & Nebula with background support

set -e

# === COLORS ===
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

clear
echo -e "${CYAN}=============================================="
echo -e " Golden Hosting Enterprise - Theme Deployer"
echo -e "==============================================${NC}"
echo

echo -e "${YELLOW}[1]${NC} Add background to default theme"
echo -e "${YELLOW}[2]${NC} Install NookTheme + background"
echo -e "${YELLOW}[3]${NC} Install / Update Nightcore + background"
echo -e "${YELLOW}[4]${NC} Install / Update Nebula + background"
echo -e "${YELLOW}[5]${NC} Uninstall Theme / Restore backup"
read -p "Choose [1-5]: " option

# Paths
WRAPPER="/var/www/pterodactyl/resources/views/templates/wrapper.blade.php"
BACKUP="$WRAPPER.bak"
IMG_DIR="/var/www/pterodactyl/public/assets/img"
CSS_FILE="/var/www/pterodactyl/public/assets/custom-background.css"
NIGHTCORE_FLAG="/var/www/pterodactyl/public/assets/nightcore-installed.flag"
NEBULA_FLAG="/var/www/pterodactyl/public/assets/nebula-installed.flag"

# === Uninstall ===
if [[ "$option" == "5" ]]; then
    if [[ -f "$BACKUP" ]]; then
        cp "$BACKUP" "$WRAPPER"
        rm -f "$CSS_FILE" "$IMG_DIR/custom_bg.jpg" "$NIGHTCORE_FLAG" "$NEBULA_FLAG"
        php /var/www/pterodactyl/artisan view:clear
        php /var/www/pterodactyl/artisan config:clear
        php /var/www/pterodactyl/artisan up
        systemctl restart nginx
        echo -e "${GREEN}✅ Backup restored. All themes reverted.${NC}"
    else
        echo -e "${RED}❌ No backup found. Cannot restore.${NC}"
    fi
    exit
fi

# === Ask for background URL ===
read -p "Paste direct image URL for background (or leave empty to skip): " bg_url
if [[ -n "$bg_url" ]]; then
    mkdir -p "$IMG_DIR"
    wget -q "$bg_url" -O "$IMG_DIR/custom_bg.jpg"
    chmod 644 "$IMG_DIR/custom_bg.jpg"

    cat <<EOF > "$CSS_FILE"
body {
  background: url('/assets/img/custom_bg.jpg') no-repeat center center fixed;
  background-size: cover;
}
EOF
fi

# === Template Injector ===
inject_wrapper() {
    [[ ! -f "$BACKUP" ]] && cp "$WRAPPER" "$BACKUP"

    cat <<'EOW' > "$WRAPPER"
<!DOCTYPE html>
<html>
    <head>
        <title>{{ config('app.name', 'Pterodactyl') }}</title>
        @section('meta')
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
            <meta name="csrf-token" content="{{ csrf_token() }}">
            <meta name="robots" content="noindex">
            <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
            <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
            <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
            <link rel="manifest" href="/favicons/manifest.json">
            <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#bc6e3c">
            <link rel="shortcut icon" href="/favicons/favicon.ico">
            <meta name="msapplication-config" content="/favicons/browserconfig.xml">
        @show

        @section('user-data')
            @if(!is_null(Auth::user()))
                <script>
                    window.PterodactylUser = {!! json_encode(Auth::user()->toVueObject()) !!};
                </script>
            @endif
            @if(!empty($siteConfiguration))
                <script>
                    window.SiteConfiguration = {!! json_encode($siteConfiguration) !!};
                </script>
            @endif
        @show

        <style>
            @import url('//fonts.googleapis.com/css?family=Rubik:300,400,500&display=swap');
            @import url('//fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:500&display=swap');
        </style>

        @yield('assets')
        @include('layouts.scripts')
        @if(file_exists(public_path('assets/custom-background.css')))
        <link rel="stylesheet" href="/assets/custom-background.css">
        @endif
    </head>
    <body class="{{ $css['body'] ?? 'bg-neutral-50' }}">
        @section('content')
            @yield('above-container')
            @yield('container')
            @yield('below-container')
            <footer style="text-align:center; padding:1em; font-size: 0.9em; color:#ccc;">
                All rights reserved by Golden Hosting Enterprise © 2025
            </footer>
        @show
        @section('scripts')
            {!! $asset->js('main.js') !!}
        @show
    </body>
</html>
EOW
}

# === Ensure Pterodactyl maintenance mode ===
cd /var/www/pterodactyl
php artisan down

# === Theme Install/Update Logic ===
case "$option" in
1)
    echo -e "${CYAN}Injecting background into default theme...${NC}"
    inject_wrapper
    ;;

2)
    # Install NookTheme
    echo -e "${CYAN}Installing NookTheme...${NC}"
    if [[ -f "$NIGHTCORE_FLAG" || -f "$NEBULA_FLAG" ]]; then
        echo -e "${YELLOW}⚠ Another theme detected. Installing NookTheme may override it.${NC}"
        read -p "Continue? [y/N]: " cont
        [[ ! "$cont" =~ ^[Yy]$ ]] && exit
    fi
    curl -L https://github.com/Nookure/NookTheme/releases/latest/download/panel.tar.gz | tar -xzv
    chmod -R 755 storage/* bootstrap/cache
    composer install --no-dev --optimize-autoloader
    php artisan migrate --seed --force
    inject_wrapper
    chown -R www-data:www-data .
    ;;

3)
    # Nightcore
    if [[ -f "$NEBULA_FLAG" ]]; then
        echo -e "${YELLOW}⚠ Nebula is installed. Installing Nightcore may conflict.${NC}"
        read -p "Continue? [y/N]: " cont
        [[ ! "$cont" =~ ^[Yy]$ ]] && exit
    fi
    if [[ -f "$NIGHTCORE_FLAG" ]]; then
        echo -e "${CYAN}Updating Nightcore...${NC}"
        bash <(curl -s https://raw.githubusercontent.com/LeXcZxMoDz9/kontol/refs/heads/main/bangke.sh) update
    else
        echo -e "${CYAN}Installing Nightcore...${NC}"
        bash <(curl -s https://raw.githubusercontent.com/LeXcZxMoDz9/kontol/refs/heads/main/bangke.sh)
        touch "$NIGHTCORE_FLAG"
    fi
    [[ -n "$bg_url" ]] && inject_wrapper
    ;;

4)
    # Nebula
    if [[ -f "$NIGHTCORE_FLAG" ]]; then
        echo -e "${YELLOW}⚠ Nightcore is installed. Installing Nebula may conflict.${NC}"
        read -p "Continue? [y/N]: " cont
        [[ ! "$cont" =~ ^[Yy]$ ]] && exit
    fi
    echo -e "${CYAN}Installing Nebula Plugin...${NC}"
    bash <(curl -s https://raw.githubusercontent.com/KiwamiXq1031/installer-premium/refs/heads/main/zero.sh) 11
    echo -e "${CYAN}Installing/Updating Nebula Theme...${NC}"
    bash <(curl -s https://raw.githubusercontent.com/LeXcZxMoDz9/kontol/refs/heads/main/bangke.sh) 2A
    touch "$NEBULA_FLAG"
    [[ -n "$bg_url" ]] && inject_wrapper
    ;;

*)
    echo -e "${RED}❌ Invalid option.${NC}"
    exit 1
    ;;
esac

# === Cleanup & restart ===
php artisan view:clear
php artisan config:clear
php artisan up
systemctl restart nginx

echo -e "${GREEN}✅ Theme deployment complete.${NC}"
